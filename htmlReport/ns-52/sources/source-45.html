


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > ProcessorRule</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.immutables.value.processor.meta</a>
</div>

<h1>Coverage Summary for Class: ProcessorRule (org.immutables.value.processor.meta)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">ProcessorRule</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/24)
  </span>
</td>
</tr>
  <tr>
    <td class="name">ProcessorRule$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ProcessorRule$LocalProcessor</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">ProcessorRule$TestImmutable</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/53)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * Copyright 2019 Immutables Authors and Contributors
&nbsp; *
&nbsp; * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp; * you may not use this file except in compliance with the License.
&nbsp; * You may obtain a copy of the License at
&nbsp; *
&nbsp; *  http://www.apache.org/licenses/LICENSE-2.0
&nbsp; *
&nbsp; * Unless required by applicable law or agreed to in writing, software
&nbsp; * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp; * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp; * See the License for the specific language governing permissions and
&nbsp; * limitations under the License.
&nbsp; */
&nbsp;
&nbsp;package org.immutables.value.processor.meta;
&nbsp;
&nbsp;import com.google.common.base.Preconditions;
&nbsp;import com.google.common.collect.ImmutableList;
&nbsp;import com.google.testing.compile.Compilation;
&nbsp;import com.google.testing.compile.Compiler;
&nbsp;import com.google.testing.compile.JavaFileObjects;
&nbsp;import org.immutables.generator.AbstractGenerator;
&nbsp;import org.junit.rules.TestRule;
&nbsp;import org.junit.runner.Description;
&nbsp;import org.junit.runners.model.Statement;
&nbsp;
&nbsp;import javax.annotation.processing.ProcessingEnvironment;
&nbsp;import javax.lang.model.element.TypeElement;
&nbsp;import javax.lang.model.util.Elements;
&nbsp;import javax.lang.model.util.Types;
&nbsp;import javax.tools.JavaFileObject;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Collections;
&nbsp;import java.util.List;
&nbsp;import java.util.Set;
&nbsp;
&nbsp;/**
&nbsp; * JUnit4 {@link org.junit.Rule} which executes test with real (in-memory) compiler and custom immutables processor.
&nbsp; * It gives access to {@link Elements} and {@link Types} as well as {@link ValueType} (for a given class).
&nbsp; *
&nbsp; * &lt;p&gt;A much better alternative to mocking {@code javax.lang.model} classes.
&nbsp; *
&nbsp; * &lt;h3&gt;Usage example&lt;/h3&gt;
&nbsp; * &lt;p&gt;
&nbsp; * &lt;pre&gt;
&nbsp; * {@code
&nbsp; * @Rule
&nbsp; * public final ProcessorRule rule = new ProcessorRule();
&nbsp; *
&nbsp; * @ProcessorRule.TestImmutable
&nbsp; * interface MyClass {
&nbsp; *   String attr();
&nbsp; * }
&nbsp; *
&nbsp; * @Test
&nbsp; * public void basic() {
&nbsp; *   ValueType type = rule.value(MyClass.class);
&nbsp; *    check(type.attributes.get(0).name()).is(&quot;attr&quot;);
&nbsp; * }
&nbsp; * }
&nbsp; * &lt;/pre&gt;
&nbsp; * &lt;/p&gt;
&nbsp; * &lt;p&gt;TODO: This rule has to be migrated to JUnit5 as &lt;a href=&quot;https://junit.org/junit5/docs/current/user-guide/#extensions&quot;&gt;extension&lt;/a&gt;.
&nbsp; * For some examples see:
&nbsp; *  &lt;ol&gt;
&nbsp; *    &lt;li&gt;&lt;a href=&quot;https://github.com/Kiskae/compile-testing-extension&quot;&gt;compile testing extension&lt;/a&gt;&lt;/li&gt;
&nbsp; *    &lt;li&gt;&lt;a href=&quot;https://github.com/google/compile-testing/pull/155&quot;&gt;Add JUnit5 implementation of CompilationRule PR&lt;/a&gt;&lt;/li&gt;
&nbsp; *  &lt;/ol&gt;
&nbsp; * &lt;/p&gt;
&nbsp; */
<b class="nc">&nbsp;public class ProcessorRule implements TestRule  {</b>
&nbsp;
<b class="nc">&nbsp;  private static final Class&lt;?&gt; DEFAULT_ANNOTATION_CLASS = TestImmutable.class;</b>
&nbsp;
&nbsp;  /**
&nbsp;   * Simple &quot;file&quot; to trigger compilation.
&nbsp;   */
<b class="nc">&nbsp;  private static final JavaFileObject EMPTY = JavaFileObjects.forSourceLines(&quot;Empty&quot;, &quot;final class Empty {}&quot;);</b>
&nbsp;
<b class="nc">&nbsp;  private final ValueTypeComposer composer = new ValueTypeComposer();</b>
&nbsp;
&nbsp;  private Elements elements;
&nbsp;  private Types types;
&nbsp;  private Round round;
&nbsp;
&nbsp;  /**
&nbsp;   * Annotation to be used instead of {@literal @}{@code Value.Immutable}. Avoids generating
&nbsp;   * unnecessary classes.
&nbsp;   */
&nbsp;  public @interface TestImmutable {}
&nbsp;
&nbsp;  /**
&nbsp;   * Returns {@link Elements} instance associated with the current execution.
&nbsp;   * @throws IllegalStateException if invoked outside the rule.
&nbsp;   */
&nbsp;  public Elements elements() {
<b class="nc">&nbsp;    Preconditions.checkState(elements != null, &quot;not running as part of %s&quot;, ProcessorRule.class.getSimpleName());</b>
<b class="nc">&nbsp;    return elements;</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Returns {@link Types} instance associated with the current execution.
&nbsp;   * @throws IllegalStateException if invoked outside the rule.
&nbsp;   */
&nbsp;  public Types types() {
<b class="nc">&nbsp;    Preconditions.checkState(types != null, &quot;not running as part of %s&quot;, ProcessorRule.class.getSimpleName());</b>
<b class="nc">&nbsp;    return types;</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Return single {@link ValueType} instance associated with immutable class {@code type}.
&nbsp;   * @throws IllegalArgumentException if multiple {@link ValueType}s are associated with {@code type}
&nbsp;   */
&nbsp;  public ValueType value(Class&lt;?&gt; type) {
<b class="nc">&nbsp;    final List&lt;ValueType&gt; values = values(type);</b>
<b class="nc">&nbsp;    if (values.size() != 1) {</b>
<b class="nc">&nbsp;      throw new IllegalArgumentException(String.format(&quot;Expected 1 values but got %d for %s&quot;, values.size(), type));</b>
&nbsp;    }
<b class="nc">&nbsp;    return values.get(0);</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Return multiple {@link ValueType} instances associated with immutable class {@code type}. Multiple
&nbsp;   * instances can be due to several nested immutable classes.
&nbsp;   */
&nbsp;  public List&lt;ValueType&gt; values(Class&lt;?&gt; type) {
<b class="nc">&nbsp;    Preconditions.checkNotNull(type, &quot;type&quot;);</b>
<b class="nc">&nbsp;    Preconditions.checkState(round != null, &quot;not running as part of %s&quot;, ProcessorRule.class.getSimpleName());</b>
<b class="nc">&nbsp;    final TypeElement element = elements().getTypeElement(type.getCanonicalName());</b>
<b class="nc">&nbsp;    final ImmutableList&lt;Proto.Protoclass&gt; protos = round.protoclassesFrom(Collections.singleton(element));</b>
<b class="nc">&nbsp;    final List&lt;ValueType&gt; values = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;    for (Proto.Protoclass proto: protos) {</b>
<b class="nc">&nbsp;      final ValueType value = new ValueType();</b>
<b class="nc">&nbsp;      composer.compose(value, proto);</b>
<b class="nc">&nbsp;      values.add(value);</b>
<b class="nc">&nbsp;    }</b>
<b class="nc">&nbsp;    return ImmutableList.copyOf(values);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Statement apply(final Statement base, final Description description) {
<b class="nc">&nbsp;    return new Statement() {</b>
&nbsp;      @Override
&nbsp;      public void evaluate() throws Throwable {
<b class="nc">&nbsp;        final LocalProcessor processor = new LocalProcessor(base);</b>
<b class="nc">&nbsp;        final Compilation compilation = Compiler.javac().withProcessors(processor).compile(EMPTY);</b>
&nbsp;
<b class="nc">&nbsp;        if (!compilation.status().equals(Compilation.Status.SUCCESS)) {</b>
<b class="nc">&nbsp;          throw new AssertionError(String.format(&quot;Compilation failed (status:%s): %s&quot;, compilation.status(), compilation.diagnostics()));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!processor.wasEvaluated) {</b>
<b class="nc">&nbsp;          throw new AssertionError(String.format(&quot;%s was not evaluated. Check that annotation processor %s was triggered &quot; +</b>
&nbsp;                          &quot;(eg. %s annotation is correctly registered)&quot;,
<b class="nc">&nbsp;                  description.getDisplayName(), processor.getClass().getSimpleName(), DEFAULT_ANNOTATION_CLASS.getCanonicalName()));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        processor.rethrowIfError();</b>
&nbsp;      }
&nbsp;    };
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Simple annotation processor which saves environment information. It is then used by this rule
&nbsp;   * to instantiate internal classes like {@link Round} which gives access to {@link ValueType}.
&nbsp;   */
<b class="nc">&nbsp;  private class LocalProcessor extends AbstractGenerator {</b>
&nbsp;
&nbsp;    private final Statement statement;
<b class="nc">&nbsp;    private final Class&lt;?&gt; annotation = DEFAULT_ANNOTATION_CLASS;</b>
&nbsp;
&nbsp;    // saved exception which is potentially rethrown after compilation phase
&nbsp;    private Throwable thrown;
&nbsp;
&nbsp;    /**
&nbsp;     * Flag to track if test statement was executed or not. Fail fast if annotation processor
&nbsp;     * was not triggered. IE detected false (no-op) test executions
&nbsp;     */
&nbsp;    private boolean wasEvaluated;
&nbsp;
<b class="nc">&nbsp;    private LocalProcessor(Statement statement) {</b>
<b class="nc">&nbsp;      this.statement = statement;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public synchronized void init(ProcessingEnvironment processingEnv) {
<b class="nc">&nbsp;      super.init(processingEnv);</b>
<b class="nc">&nbsp;      elements = processingEnv.getElementUtils();</b>
<b class="nc">&nbsp;      types = processingEnv.getTypeUtils();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public Set&lt;String&gt; getSupportedAnnotationTypes() {
&nbsp;      // for some reason annotation.getCanonicalName() is not found
&nbsp;      // using wildcard here
<b class="nc">&nbsp;      return Collections.singleton(&quot;*&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    protected void process() {
<b class="nc">&nbsp;      round = ImmutableRound.builder()</b>
<b class="nc">&nbsp;              .processing(processing())</b>
<b class="nc">&nbsp;              .round(round())</b>
<b class="nc">&nbsp;              .addCustomImmutableAnnotations(annotation.getCanonicalName())</b>
<b class="nc">&nbsp;              .build();</b>
&nbsp;
&nbsp;      try {
<b class="nc">&nbsp;        statement.evaluate();</b>
<b class="nc">&nbsp;      } catch (Throwable e) {</b>
&nbsp;        // means test failed
<b class="nc">&nbsp;        thrown = e;</b>
<b class="nc">&nbsp;      }</b>
&nbsp;
&nbsp;      // mark that statement was executed
<b class="nc">&nbsp;      wasEvaluated = true;</b>
&nbsp;    }
&nbsp;
&nbsp;    void rethrowIfError() throws Throwable {
<b class="nc">&nbsp;      if (thrown != null) {</b>
<b class="nc">&nbsp;        throw thrown;</b>
&nbsp;      }
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-04 15:34</div>
</div>
</body>
</html>
