


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > GsonMessageBodyProvider</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.immutables.gson.stream</a>
</div>

<h1>Coverage Summary for Class: GsonMessageBodyProvider (org.immutables.gson.stream)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">GsonMessageBodyProvider</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/44)
  </span>
</td>
</tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$1$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$ExceptionHandler</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$GsonOptions</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/15)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$GsonProviderOptions</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/9)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$GsonStreamer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/31)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$GsonStreamer$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$JacksonStreamer</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/14)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/39)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$JsonError</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">GsonMessageBodyProvider$Streamer</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/36)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/44)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/160)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp;   Copyright 2015 Immutables Authors and Contributors
&nbsp;
&nbsp;   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp;   you may not use this file except in compliance with the License.
&nbsp;   You may obtain a copy of the License at
&nbsp;
&nbsp;       http://www.apache.org/licenses/LICENSE-2.0
&nbsp;
&nbsp;   Unless required by applicable law or agreed to in writing, software
&nbsp;   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp;   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp;   See the License for the specific language governing permissions and
&nbsp;   limitations under the License.
&nbsp; */
&nbsp;package org.immutables.gson.stream;
&nbsp;
&nbsp;import com.fasterxml.jackson.core.JsonFactory;
&nbsp;import com.fasterxml.jackson.core.JsonGenerator;
&nbsp;import com.fasterxml.jackson.core.JsonParser;
&nbsp;import com.google.common.annotations.VisibleForTesting;
&nbsp;import com.google.gson.Gson;
&nbsp;import com.google.gson.GsonBuilder;
&nbsp;import com.google.gson.JsonParseException;
&nbsp;import com.google.gson.TypeAdapterFactory;
&nbsp;import com.google.gson.reflect.TypeToken;
&nbsp;import com.google.gson.stream.JsonReader;
&nbsp;import com.google.gson.stream.JsonToken;
&nbsp;import com.google.gson.stream.JsonWriter;
&nbsp;import java.io.BufferedReader;
&nbsp;import java.io.BufferedWriter;
&nbsp;import java.io.IOException;
&nbsp;import java.io.InputStream;
&nbsp;import java.io.InputStreamReader;
&nbsp;import java.io.OutputStream;
&nbsp;import java.io.OutputStreamWriter;
&nbsp;import java.io.Reader;
&nbsp;import java.io.Writer;
&nbsp;import java.lang.annotation.Annotation;
&nbsp;import java.lang.reflect.Field;
&nbsp;import java.lang.reflect.Type;
&nbsp;import java.nio.charset.StandardCharsets;
&nbsp;import java.util.Collections;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.List;
&nbsp;import java.util.ServiceLoader;
&nbsp;import java.util.Set;
&nbsp;import javax.annotation.Nullable;
&nbsp;import javax.ws.rs.Consumes;
&nbsp;import javax.ws.rs.Produces;
&nbsp;import javax.ws.rs.WebApplicationException;
&nbsp;import javax.ws.rs.core.MediaType;
&nbsp;import javax.ws.rs.core.MultivaluedMap;
&nbsp;import javax.ws.rs.core.Response;
&nbsp;import javax.ws.rs.core.Response.Status;
&nbsp;import javax.ws.rs.core.StreamingOutput;
&nbsp;import javax.ws.rs.ext.MessageBodyReader;
&nbsp;import javax.ws.rs.ext.MessageBodyWriter;
&nbsp;import javax.ws.rs.ext.Provider;
&nbsp;import org.immutables.metainf.Metainf;
&nbsp;import org.immutables.value.Value;
&nbsp;import org.immutables.value.Value.Style.ImplementationVisibility;
&nbsp;
&nbsp;/**
&nbsp; * Gson serialization provider for JAX-RS 1.0 and JAX-RS 2.0.
&nbsp; */
&nbsp;@Provider
&nbsp;@Metainf.Service
&nbsp;@Consumes(MediaType.WILDCARD)
&nbsp;@Produces(MediaType.WILDCARD)
&nbsp;@SuppressWarnings({&quot;resource&quot;, &quot;unused&quot;})
<b class="nc">&nbsp;public class GsonMessageBodyProvider implements MessageBodyReader&lt;Object&gt;, MessageBodyWriter&lt;Object&gt; {</b>
&nbsp;  private final Gson gson;
&nbsp;  private final Set&lt;MediaType&gt; mediaTypes;
&nbsp;  private final Streamer streamer;
&nbsp;  private final ExceptionHandler exceptionHandler;
&nbsp;
&nbsp;  /**
&nbsp;   * Creates new provider with internally configured {@link Gson} instance,
&nbsp;   * and {@link MediaType#APPLICATION_JSON_TYPE application/json} media type to match.
&nbsp;   */
&nbsp;  public GsonMessageBodyProvider() {
<b class="nc">&nbsp;    this(new GsonProviderOptionsBuilder().build());</b>
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Creates new provider with flexible setup.
&nbsp;   * @param options options for provider
&nbsp;   */
<b class="nc">&nbsp;  public GsonMessageBodyProvider(GsonProviderOptions options) {</b>
<b class="nc">&nbsp;    this.gson = options.gson();</b>
<b class="nc">&nbsp;    this.mediaTypes = mediaSetFrom(options.mediaTypes());</b>
<b class="nc">&nbsp;    this.streamer = createStreamer(options.allowJackson(),</b>
<b class="nc">&nbsp;        new GsonOptions(options.gson(), options.lenient()));</b>
<b class="nc">&nbsp;    this.exceptionHandler = options.exceptionHandler();</b>
&nbsp;  }
&nbsp;
&nbsp;  private static Streamer createStreamer(boolean allowJacksonIfAvailable, GsonOptions options) {
<b class="nc">&nbsp;    if (allowJacksonIfAvailable) {</b>
&nbsp;      try {
<b class="nc">&nbsp;        return new JacksonStreamer(options);</b>
<b class="nc">&nbsp;      } catch (Throwable ex) {</b>
&nbsp;        // cannot load jackson streamer class, fallback to default
&nbsp;      }
&nbsp;    }
<b class="nc">&nbsp;    return new GsonStreamer(options);</b>
&nbsp;  }
&nbsp;
&nbsp;  private static Set&lt;MediaType&gt; mediaSetFrom(List&lt;MediaType&gt; mediaTypes) {
<b class="nc">&nbsp;    if (mediaTypes.isEmpty()) {</b>
<b class="nc">&nbsp;      return Collections.singleton(MediaType.APPLICATION_JSON_TYPE);</b>
&nbsp;    }
<b class="nc">&nbsp;    return new HashSet&lt;MediaType&gt;(mediaTypes);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public boolean isWriteable(Class&lt;?&gt; type, Type genericType, Annotation[] annotations, MediaType mediaType) {
<b class="nc">&nbsp;    return mediaTypes.contains(mediaType) &amp;&amp; !UNSUPPORTED_TYPES.contains(type);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public boolean isReadable(Class&lt;?&gt; type, Type genericType, Annotation[] annotations, MediaType mediaType) {
<b class="nc">&nbsp;    return mediaTypes.contains(mediaType) &amp;&amp; !UNSUPPORTED_TYPES.contains(type);</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public long getSize(Object t, Class&lt;?&gt; type, Type genericType, Annotation[] annotations, MediaType mediaType) {
<b class="nc">&nbsp;    return -1;</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public void writeTo(
&nbsp;      Object t,
&nbsp;      Class&lt;?&gt; type,
&nbsp;      Type genericType,
&nbsp;      Annotation[] annotations,
&nbsp;      MediaType mediaType,
&nbsp;      MultivaluedMap&lt;String, Object&gt; httpHeaders,
&nbsp;      OutputStream entityStream)
&nbsp;      throws IOException,
&nbsp;        WebApplicationException {
&nbsp;    // Special case of unsupported type, where surrounding framework
&nbsp;    // may have, mistakengly, chosen this provider based on media type, but when
&nbsp;    // response will be streamed using StreamingOutput or is already prepared using
&nbsp;    // in the form of CharSequence
<b class="nc">&nbsp;    if (t instanceof StreamingOutput) {</b>
<b class="nc">&nbsp;      ((StreamingOutput) t).write(entityStream);</b>
&nbsp;      return;
&nbsp;    }
<b class="nc">&nbsp;    if (t instanceof CharSequence) {</b>
&nbsp;      // UTF-8 used because it should be considered default encoding for the JSON-family
&nbsp;      // of media types
<b class="nc">&nbsp;      OutputStreamWriter writer = new OutputStreamWriter(entityStream, StandardCharsets.UTF_8);</b>
<b class="nc">&nbsp;      writer.append((CharSequence) t);</b>
<b class="nc">&nbsp;      writer.flush();</b>
&nbsp;      return;
&nbsp;    }
&nbsp;    // Standard way of handling writing using gson
&nbsp;    try {
<b class="nc">&nbsp;      streamer.write(gson, genericType, t, entityStream);</b>
<b class="nc">&nbsp;    } catch (IOException ex) {</b>
<b class="nc">&nbsp;      exceptionHandler.onWrite(gson, ex);</b>
<b class="nc">&nbsp;      throw ex;</b>
<b class="nc">&nbsp;    }</b>
&nbsp;  }
&nbsp;
&nbsp;  @Override
&nbsp;  public Object readFrom(
&nbsp;      Class&lt;Object&gt; type,
&nbsp;      Type genericType,
&nbsp;      Annotation[] annotations,
&nbsp;      MediaType mediaType,
&nbsp;      MultivaluedMap&lt;String, String&gt; httpHeaders,
&nbsp;      InputStream entityStream)
&nbsp;      throws IOException,
&nbsp;        WebApplicationException {
&nbsp;    try {
<b class="nc">&nbsp;      return streamer.read(gson, genericType, entityStream);</b>
<b class="nc">&nbsp;    } catch (IOException ex) {</b>
<b class="nc">&nbsp;      exceptionHandler.onRead(gson, ex);</b>
<b class="nc">&nbsp;      throw ex;</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private interface Streamer {
&nbsp;    void write(Gson gson, Type type, Object object, OutputStream stream) throws IOException;
&nbsp;
&nbsp;    Object read(Gson gson, Type type, InputStream stream) throws IOException;
&nbsp;  }
&nbsp;
&nbsp;  private static class GsonStreamer implements Streamer {
&nbsp;    private static final String CHARSET_NAME = &quot;utf-8&quot;;
&nbsp;    private final GsonOptions options;
&nbsp;
<b class="nc">&nbsp;    GsonStreamer(GsonOptions options) {</b>
<b class="nc">&nbsp;      this.options = options;</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;unchecked&quot;)
&nbsp;    @Override
&nbsp;    public void write(Gson gson, Type type, Object object, OutputStream stream) throws IOException {
<b class="nc">&nbsp;      @Nullable JsonWriter writer = null;</b>
<b class="nc">&nbsp;      boolean wasOriginalException = false;</b>
&nbsp;      try {
<b class="nc">&nbsp;        writer = new JsonWriter(new BufferedWriter(new OutputStreamWriter(stream, CHARSET_NAME)));</b>
<b class="nc">&nbsp;        options.setWriterOptions(writer);</b>
&nbsp;
<b class="nc">&nbsp;        gson.getAdapter((TypeToken&lt;Object&gt;) TypeToken.get(type)).write(writer, object);</b>
<b class="nc">&nbsp;      } catch (IOException ex) {</b>
<b class="nc">&nbsp;        wasOriginalException = true;</b>
<b class="nc">&nbsp;        throw ex;</b>
<b class="nc">&nbsp;      } catch (Exception ex) {</b>
<b class="nc">&nbsp;        wasOriginalException = true;</b>
<b class="nc">&nbsp;        throw new IOException(ex);</b>
&nbsp;      } finally {
<b class="nc">&nbsp;        if (writer != null) {</b>
&nbsp;          try {
&nbsp;            // underlying stream should not be closed, just flushing
<b class="nc">&nbsp;            writer.flush();</b>
<b class="nc">&nbsp;          } catch (IOException ex) {</b>
<b class="nc">&nbsp;            if (!wasOriginalException) {</b>
<b class="nc">&nbsp;              throw ex;</b>
&nbsp;            }
<b class="nc">&nbsp;          }</b>
&nbsp;        }
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;unchecked&quot;)
&nbsp;    @Override
&nbsp;    public Object read(Gson gson, Type type, InputStream stream) throws IOException {
<b class="nc">&nbsp;      @Nullable JsonReader reader = null;</b>
&nbsp;      try {
<b class="nc">&nbsp;        reader = createJsonReader(new BufferedReader(new InputStreamReader(stream, CHARSET_NAME)));</b>
<b class="nc">&nbsp;        options.setReaderOptions(reader);</b>
&nbsp;
<b class="nc">&nbsp;        return gson.getAdapter((TypeToken&lt;Object&gt;) TypeToken.get(type)).read(reader);</b>
<b class="nc">&nbsp;      } catch (IOException ex) {</b>
<b class="nc">&nbsp;        throw ex;</b>
<b class="nc">&nbsp;      } catch (Exception ex) {</b>
<b class="nc">&nbsp;        throw new IOException(ex);</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    /** Forces creation of more strict in string reading if in !lenient mode */
&nbsp;    private JsonReader createJsonReader(Reader reader) {
<b class="nc">&nbsp;      if (!options.lenient) {</b>
<b class="nc">&nbsp;        return new JsonReader(reader) {</b>
&nbsp;          @Override
&nbsp;          public String nextString() throws IOException {
<b class="nc">&nbsp;            JsonToken peeked = peek();</b>
<b class="nc">&nbsp;            if (peeked == JsonToken.STRING) {</b>
<b class="nc">&nbsp;              return super.nextString();</b>
&nbsp;            }
<b class="nc">&nbsp;            throw new JsonParseException(</b>
<b class="nc">&nbsp;                String.format(&quot;In strict mode (!lenient) string read only from string literal, not %s. Path: %s&quot;,</b>
&nbsp;                    peeked,
<b class="nc">&nbsp;                    getPath()));</b>
&nbsp;          }
&nbsp;        };
&nbsp;      }
<b class="nc">&nbsp;      return new JsonReader(reader);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private static class JacksonStreamer implements Streamer {
<b class="nc">&nbsp;    private static final JsonFactory JSON_FACTORY = new JsonFactory()</b>
<b class="nc">&nbsp;        .disable(JsonParser.Feature.AUTO_CLOSE_SOURCE)</b>
<b class="nc">&nbsp;        .disable(JsonGenerator.Feature.AUTO_CLOSE_TARGET);</b>
&nbsp;
&nbsp;    private final GsonOptions options;
&nbsp;
<b class="nc">&nbsp;    JacksonStreamer(GsonOptions options) {</b>
<b class="nc">&nbsp;      this.options = options;</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;unchecked&quot;)
&nbsp;    @Override
&nbsp;    public void write(Gson gson, Type type, Object object, OutputStream stream) throws IOException {
<b class="nc">&nbsp;      @Nullable JsonGeneratorWriter writer = null;</b>
<b class="nc">&nbsp;      boolean wasOriginalException = false;</b>
&nbsp;      try {
<b class="nc">&nbsp;        JsonGenerator generator = JSON_FACTORY.createGenerator(stream);</b>
<b class="nc">&nbsp;        if (options.prettyPrinting) {</b>
<b class="nc">&nbsp;          generator.useDefaultPrettyPrinter();</b>
&nbsp;        }
<b class="nc">&nbsp;        writer = new JsonGeneratorWriter(generator);</b>
<b class="nc">&nbsp;        options.setWriterOptions(writer);</b>
&nbsp;
<b class="nc">&nbsp;        gson.getAdapter((TypeToken&lt;Object&gt;) TypeToken.get(type)).write(writer, object);</b>
<b class="nc">&nbsp;      } catch (IOException ex) {</b>
<b class="nc">&nbsp;        wasOriginalException = true;</b>
<b class="nc">&nbsp;        throw ex;</b>
<b class="nc">&nbsp;      } catch (Exception ex) {</b>
<b class="nc">&nbsp;        wasOriginalException = true;</b>
<b class="nc">&nbsp;        throw new IOException(ex);</b>
&nbsp;      } finally {
<b class="nc">&nbsp;        if (writer != null) {</b>
&nbsp;          try {
&nbsp;            // note that stream is not closed here as per JSON_FACTORY configuration
<b class="nc">&nbsp;            writer.close();</b>
<b class="nc">&nbsp;          } catch (IOException ex) {</b>
<b class="nc">&nbsp;            if (!wasOriginalException) {</b>
<b class="nc">&nbsp;              throw ex;</b>
&nbsp;            }
<b class="nc">&nbsp;          }</b>
&nbsp;        }
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;
&nbsp;    @SuppressWarnings(&quot;unchecked&quot;)
&nbsp;    @Override
&nbsp;    public Object read(Gson gson, Type type, InputStream stream) throws IOException {
<b class="nc">&nbsp;      @Nullable JsonReader reader = null;</b>
&nbsp;      try {
<b class="nc">&nbsp;        reader = new JsonParserReader(JSON_FACTORY.createParser(stream));</b>
<b class="nc">&nbsp;        options.setReaderOptions(reader);</b>
<b class="nc">&nbsp;        return gson.getAdapter((TypeToken&lt;Object&gt;) TypeToken.get(type)).read(reader);</b>
<b class="nc">&nbsp;      } catch (IOException ex) {</b>
<b class="nc">&nbsp;        throw ex;</b>
<b class="nc">&nbsp;      } catch (Exception ex) {</b>
<b class="nc">&nbsp;        throw new IOException(ex);</b>
&nbsp;      } finally {
<b class="nc">&nbsp;        if (reader != null) {</b>
&nbsp;          try {
&nbsp;            // note that stream is not closed here as per JSON_FACTORY configuration
<b class="nc">&nbsp;            reader.close();</b>
<b class="nc">&nbsp;          } catch (IOException ex) {</b>
&nbsp;            // ignore io exception of reader close as not important
<b class="nc">&nbsp;          }</b>
&nbsp;        }
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Implement streaming exception handler. If now exception will be thrown by handler methods,
&nbsp;   * original {@link IOException} will be rethrown. Note that any runtime exceptions thrown by
&nbsp;   * {@code Gson} will be wrapped in {@link IOException} passed in.
&nbsp;   */
&nbsp;  public interface ExceptionHandler {
&nbsp;    /**
&nbsp;     * Handles read exception. Can throw checked {@link IOException} or any runtime exception,
&nbsp;     * including {@link WebApplicationException}.
&nbsp;     * @param gson gson instance if Gson serializer needed to format error response.
&nbsp;     * @param exception thrown from within {@link Gson}
&nbsp;     * @throws IOException IO exception, to be handled by JAX-RS implementation
&nbsp;     * @throws WebApplicationException exception which forces certain response
&nbsp;     * @throws RuntimeException any runtime exception to be handled by JAX-RS implementation
&nbsp;     */
&nbsp;    void onRead(Gson gson, IOException exception) throws IOException, WebApplicationException, RuntimeException;
&nbsp;
&nbsp;    /**
&nbsp;     * Handles write exception. Can throw checked {@link IOException} or any runtime exception,
&nbsp;     * including {@link WebApplicationException}.
&nbsp;     * @param gson gson instance if Gson serializer needed to format error response.
&nbsp;     * @param exception thrown from within {@link Gson}
&nbsp;     * @throws IOException IO exception, to be handled by JAX-RS implementation
&nbsp;     * @throws WebApplicationException exception which forces certain response
&nbsp;     * @throws RuntimeException any runtime exception to be handled by JAX-RS implementation
&nbsp;     */
&nbsp;    void onWrite(Gson gson, IOException exception) throws IOException, WebApplicationException, RuntimeException;
&nbsp;  }
&nbsp;
&nbsp;  /**
&nbsp;   * Use {@link GsonProviderOptionsBuilder} to build instances of {@code GsonProviderOptions}.
&nbsp;   */
&nbsp;  @Value.Immutable
&nbsp;  @Value.Style(
&nbsp;      jdkOnly = true,
&nbsp;      visibility = ImplementationVisibility.PRIVATE)
<b class="nc">&nbsp;  public static abstract class GsonProviderOptions {</b>
&nbsp;    /**
&nbsp;     * the fully configured gson instance.
&nbsp;     * @return the gson instanse
&nbsp;     */
&nbsp;    @Value.Default
&nbsp;    public Gson gson() {
<b class="nc">&nbsp;      GsonBuilder gsonBuilder = new GsonBuilder();</b>
<b class="nc">&nbsp;      for (TypeAdapterFactory factory : ServiceLoader.load(TypeAdapterFactory.class)) {</b>
<b class="nc">&nbsp;        gsonBuilder.registerTypeAdapterFactory(factory);</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      return gsonBuilder.create();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Allows Jackson streaming optimization if Jackson if available in
&nbsp;     * classpath. Use {@code false} to disable optimization and use pure Gson.
&nbsp;     * @return {@code true} if Jackson allowed
&nbsp;     */
&nbsp;    @Value.Default
&nbsp;    public boolean allowJackson() {
<b class="nc">&nbsp;      return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * if {@code true} - enables non strict parsing and serialization.
&nbsp;     * @return true, if successful
&nbsp;     */
&nbsp;    @Value.Default
&nbsp;    public boolean lenient() {
<b class="nc">&nbsp;      return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Streaming exception handler to use.
&nbsp;     * @return exception handler.
&nbsp;     */
&nbsp;    @Value.Default
&nbsp;    public ExceptionHandler exceptionHandler() {
<b class="nc">&nbsp;      return DEFAULT_EXCEPTION_HANDLER;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Handled media types
&nbsp;     * @return media types
&nbsp;     */
&nbsp;    public abstract List&lt;MediaType&gt; mediaTypes();
&nbsp;  }
&nbsp;
&nbsp;  @VisibleForTesting
&nbsp;  final static class GsonOptions {
&nbsp;    final boolean lenient;
&nbsp;    final boolean serializeNulls;
&nbsp;    final boolean htmlSafe;
&nbsp;    final boolean prettyPrinting;
&nbsp;
<b class="nc">&nbsp;    GsonOptions(Gson gson, boolean lenient) {</b>
<b class="nc">&nbsp;      this.lenient = lenient;</b>
<b class="nc">&nbsp;      this.htmlSafe = gson.htmlSafe();</b>
<b class="nc">&nbsp;      this.serializeNulls = gson.serializeNulls();</b>
<b class="nc">&nbsp;      this.prettyPrinting = accessField(gson, &quot;prettyPrinting&quot;, false);</b>
&nbsp;    }
&nbsp;
&nbsp;    private static boolean accessField(Gson gson, String name, boolean defaultValue) {
&nbsp;      try {
<b class="nc">&nbsp;        Field field = Gson.class.getDeclaredField(name);</b>
<b class="nc">&nbsp;        field.setAccessible(true);</b>
<b class="nc">&nbsp;        return (Boolean) field.get(gson);</b>
<b class="nc">&nbsp;      } catch (Exception ex) {</b>
<b class="nc">&nbsp;        return defaultValue;</b>
&nbsp;      }
&nbsp;    }
&nbsp;
&nbsp;    void setReaderOptions(JsonReader reader) {
<b class="nc">&nbsp;      reader.setLenient(lenient);</b>
&nbsp;    }
&nbsp;
&nbsp;    void setWriterOptions(JsonWriter writer) {
<b class="nc">&nbsp;      writer.setSerializeNulls(serializeNulls);</b>
<b class="nc">&nbsp;      writer.setLenient(lenient);</b>
<b class="nc">&nbsp;      writer.setHtmlSafe(htmlSafe);</b>
<b class="nc">&nbsp;      writer.setIndent(prettyPrinting ? &quot;  &quot; : &quot;&quot;);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  private static final Set&lt;Class&lt;?&gt;&gt; UNSUPPORTED_TYPES = new HashSet&lt;&gt;();</b>
&nbsp;  static {
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(InputStream.class);</b>
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(Reader.class);</b>
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(OutputStream.class);</b>
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(Writer.class);</b>
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(byte[].class);</b>
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(char[].class);</b>
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(String.class);</b>
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(StreamingOutput.class);</b>
<b class="nc">&nbsp;    UNSUPPORTED_TYPES.add(Response.class);</b>
&nbsp;  }
&nbsp;
&nbsp;  static class JsonError {
&nbsp;    final String error;
&nbsp;
<b class="nc">&nbsp;    JsonError(String error) {</b>
<b class="nc">&nbsp;      this.error = error;</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  private static final ExceptionHandler DEFAULT_EXCEPTION_HANDLER = new ExceptionHandler() {</b>
&nbsp;    @Override
<b class="nc">&nbsp;    public void onWrite(Gson gson, IOException ex) {}</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public void onRead(final Gson gson, final IOException ex) {
<b class="nc">&nbsp;      StreamingOutput output = new StreamingOutput() {</b>
&nbsp;        @Override
&nbsp;        public void write(OutputStream output) throws IOException, WebApplicationException {
<b class="nc">&nbsp;          OutputStreamWriter writer = new OutputStreamWriter(output);</b>
<b class="nc">&nbsp;          gson.toJson(new JsonError(ex.getCause().getMessage()), writer);</b>
<b class="nc">&nbsp;          writer.flush();</b>
&nbsp;        }
&nbsp;      };
<b class="nc">&nbsp;      if (ex.getCause() instanceof RuntimeException) {</b>
<b class="nc">&nbsp;        throw new WebApplicationException(</b>
<b class="nc">&nbsp;            Response.status(Status.BAD_REQUEST)</b>
<b class="nc">&nbsp;                .type(MediaType.APPLICATION_JSON_TYPE)</b>
<b class="nc">&nbsp;                .entity(output)</b>
<b class="nc">&nbsp;                .build());</b>
&nbsp;      }
&nbsp;    }
&nbsp;  };
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-04 15:34</div>
</div>
</body>
</html>
