


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > Output</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.immutables.generator</a>
</div>

<h1>Coverage Summary for Class: Output (org.immutables.generator)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Output</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/5)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
</tr>
  <tr>
    <td class="name">Output$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$2</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$3</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$4</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$5</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$6</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$7</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$8</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/7)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$AppendServiceFile</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/8)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/16)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/34)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$Cache</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/12)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$Files</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$Files$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$FilesSupplier</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$OutputFilter</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/10)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$ResourceKey</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/13)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$ServiceFiles</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/6)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$ServiceFiles$1</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/2)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$ServiceFilesSupplier</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/3)
  </span>
</td>
  </tr>
  <tr>
    <td class="name">Output$SourceFile</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/4)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/20)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/38)
  </span>
</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/60)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/60)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/189)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp;   Copyright 2014-2018 Immutables Authors and Contributors
&nbsp;
&nbsp;   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
&nbsp;   you may not use this file except in compliance with the License.
&nbsp;   You may obtain a copy of the License at
&nbsp;
&nbsp;       http://www.apache.org/licenses/LICENSE-2.0
&nbsp;
&nbsp;   Unless required by applicable law or agreed to in writing, software
&nbsp;   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
&nbsp;   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
&nbsp;   See the License for the specific language governing permissions and
&nbsp;   limitations under the License.
&nbsp; */
&nbsp;package org.immutables.generator;
&nbsp;
&nbsp;import com.google.common.base.CharMatcher;
&nbsp;import com.google.common.base.Joiner;
&nbsp;import com.google.common.base.Predicates;
&nbsp;import com.google.common.base.Splitter;
&nbsp;import com.google.common.base.Strings;
&nbsp;import com.google.common.base.Supplier;
&nbsp;import com.google.common.base.Throwables;
&nbsp;import com.google.common.collect.Iterables;
&nbsp;import com.google.common.collect.Iterators;
&nbsp;import com.google.common.collect.Sets;
&nbsp;import com.google.common.io.CharStreams;
&nbsp;import java.io.IOException;
&nbsp;import java.io.Reader;
&nbsp;import java.io.Writer;
&nbsp;import java.util.Collection;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.LinkedHashSet;
&nbsp;import java.util.Map;
&nbsp;import java.util.Objects;
&nbsp;import java.util.regex.Pattern;
&nbsp;import javax.annotation.Nullable;
&nbsp;import javax.annotation.concurrent.NotThreadSafe;
&nbsp;import javax.annotation.processing.Filer;
&nbsp;import javax.annotation.processing.FilerException;
&nbsp;import javax.annotation.processing.Messager;
&nbsp;import javax.lang.model.element.Element;
&nbsp;import javax.tools.Diagnostic;
&nbsp;import javax.tools.Diagnostic.Kind;
&nbsp;import javax.tools.FileObject;
&nbsp;import javax.tools.JavaFileObject;
&nbsp;import javax.tools.StandardLocation;
&nbsp;import org.immutables.generator.Templates.Invokable;
&nbsp;import org.immutables.generator.Templates.Invokation;
&nbsp;import static com.google.common.base.Preconditions.checkNotNull;
&nbsp;
<b class="nc">&nbsp;public final class Output {</b>
&nbsp;  /**
&nbsp;   * Pragma-like comment indicator just at beginning of the source file used to disable import
&nbsp;   * post-processing.
&nbsp;   */
&nbsp;  public static final String NO_IMPORTS = &quot;//-no-import-rewrite&quot;;
&nbsp;
<b class="nc">&nbsp;  public final Templates.Invokable error = new Templates.Invokable() {</b>
&nbsp;    @Override
&nbsp;    @Nullable
&nbsp;    public Invokable invoke(Invokation invokation, Object... parameters) {
<b class="nc">&nbsp;      Messager messager = EnvironmentState.processing().getMessager();</b>
<b class="nc">&nbsp;      String message = CharMatcher.whitespace().trimFrom(parameters[parameters.length - 1].toString());</b>
<b class="nc">&nbsp;      Element element = (Element) Iterators.find(</b>
<b class="nc">&nbsp;          Iterators.forArray(parameters),</b>
<b class="nc">&nbsp;          Predicates.instanceOf(Element.class),</b>
&nbsp;          null);
<b class="nc">&nbsp;      if (element != null) {</b>
<b class="nc">&nbsp;        messager.printMessage(Diagnostic.Kind.ERROR, message, Delegated.unwrap(element));</b>
&nbsp;      } else {
<b class="nc">&nbsp;        messager.printMessage(Diagnostic.Kind.ERROR, message);</b>
&nbsp;      }
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;  };
&nbsp;
<b class="nc">&nbsp;  public final Templates.Invokable system = new Templates.Invokable() {</b>
&nbsp;    @Override
&nbsp;    @Nullable
&nbsp;    public Invokable invoke(Invokation invokation, Object... parameters) {
<b class="nc">&nbsp;      String message = CharMatcher.whitespace().trimFrom(parameters[0].toString());</b>
&nbsp;      // this is not a debug line, we are printing to system out
<b class="nc">&nbsp;      System.out.println(message);</b>
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;  };
&nbsp;
<b class="nc">&nbsp;  public final Templates.Invokable length = new Templates.Invokable() {</b>
&nbsp;    @Override
&nbsp;    @Nullable
&nbsp;    public Invokable invoke(Invokation invokation, Object... parameters) {
<b class="nc">&nbsp;      invokation.out(parameters[0].toString().length());</b>
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;  };
&nbsp;
&nbsp;  private static abstract class OutputFilter extends Templates.Fragment {
&nbsp;    public OutputFilter() {
<b class="nc">&nbsp;      super(1);</b>
&nbsp;    }
&nbsp;
&nbsp;    abstract void apply(Invokation invokation, CharSequence content, @Nullable Templates.Invokable original);
&nbsp;
&nbsp;    @Override
&nbsp;    public final void run(Invokation invokation) {
<b class="nc">&nbsp;      Object param = invokation.param(0);</b>
<b class="nc">&nbsp;      Invokable original = param instanceof Templates.Invokable</b>
<b class="nc">&nbsp;          ? (Templates.Invokable) param</b>
<b class="nc">&nbsp;          : null;</b>
&nbsp;
<b class="nc">&nbsp;      apply(invokation, toCharSequence(param), original);</b>
&nbsp;    }
&nbsp;
&nbsp;    private CharSequence toCharSequence(Object param) {
<b class="nc">&nbsp;      checkNotNull(param);</b>
&nbsp;      // Is it worthwhile optimization?
<b class="nc">&nbsp;      if (param instanceof Templates.Fragment) {</b>
<b class="nc">&nbsp;        return ((Templates.Fragment) param).toCharSequence();</b>
&nbsp;      }
<b class="nc">&nbsp;      return param.toString();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  public final Templates.Invokable trim = new OutputFilter() {</b>
&nbsp;    @Override
&nbsp;    void apply(Invokation invokation, CharSequence content, @Nullable Templates.Invokable original) {
<b class="nc">&nbsp;      invokation.out(CharMatcher.whitespace().trimFrom(content));</b>
&nbsp;    }
&nbsp;  };
&nbsp;
<b class="nc">&nbsp;  public final Templates.Invokable linesShortable = new OutputFilter() {</b>
&nbsp;    private static final int LIMIT = 100;
&nbsp;
&nbsp;    @Override
&nbsp;    void apply(Invokation invokation, CharSequence content, @Nullable Templates.Invokable original) {
<b class="nc">&nbsp;      String collapsed = CharMatcher.whitespace().trimAndCollapseFrom(content, &#39; &#39;);</b>
<b class="nc">&nbsp;      int estimatedLimitOnThisLine = LIMIT - invokation.consumer.getCurrentIndentation().length();</b>
&nbsp;
<b class="nc">&nbsp;      if (collapsed.length() &lt; estimatedLimitOnThisLine) {</b>
<b class="nc">&nbsp;        invokation.out(collapsed);</b>
&nbsp;      } else {
<b class="nc">&nbsp;        if (original != null) {</b>
<b class="nc">&nbsp;          original.invoke(invokation);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          invokation.out(content);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;  };
&nbsp;
<b class="nc">&nbsp;  public final Templates.Invokable collapsible = new OutputFilter() {</b>
&nbsp;    @Override
&nbsp;    void apply(Invokation invokation, CharSequence content, @Nullable Templates.Invokable original) {
<b class="nc">&nbsp;      boolean hasNonWhitespace = !CharMatcher.whitespace().matchesAllOf(content);</b>
<b class="nc">&nbsp;      if (hasNonWhitespace) {</b>
<b class="nc">&nbsp;        if (original != null) {</b>
<b class="nc">&nbsp;          original.invoke(invokation);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          invokation.out(content);</b>
&nbsp;        }
&nbsp;      }
&nbsp;    }
&nbsp;  };
&nbsp;
<b class="nc">&nbsp;  public final Templates.Invokable java = new Templates.Invokable() {</b>
&nbsp;    @Override
&nbsp;    public Invokable invoke(Invokation invokation, Object... parameters) {
<b class="nc">&nbsp;      String packageName = parameters[0].toString();</b>
<b class="nc">&nbsp;      String simpleName = parameters[1].toString();</b>
<b class="nc">&nbsp;      Element originatingElement = (Element) parameters[2];</b>
<b class="nc">&nbsp;      Invokable body = (Invokable) parameters[3];</b>
&nbsp;
<b class="nc">&nbsp;      ResourceKey key = new ResourceKey(packageName, simpleName, originatingElement);</b>
<b class="nc">&nbsp;      SourceFile javaFile = getFiles().sourceFiles.get(key);</b>
<b class="nc">&nbsp;      body.invoke(new Invokation(javaFile.consumer));</b>
<b class="nc">&nbsp;      javaFile.complete();</b>
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;  };
&nbsp;
<b class="nc">&nbsp;  public final Templates.Invokable service = new Templates.Invokable() {</b>
&nbsp;    private static final String META_INF_SERVICES = &quot;META-INF/services/&quot;;
&nbsp;
&nbsp;    @Override
&nbsp;    public Invokable invoke(Invokation invokation, Object... parameters) {
<b class="nc">&nbsp;      String interfaceName = parameters[0].toString();</b>
<b class="nc">&nbsp;      Invokable body = (Invokable) parameters[1];</b>
&nbsp;
<b class="nc">&nbsp;      ResourceKey key = new ResourceKey(&quot;&quot;, META_INF_SERVICES + interfaceName);</b>
<b class="nc">&nbsp;      AppendServiceFile servicesFile = getServiceFiles().appendResourceFiles.get(key);</b>
<b class="nc">&nbsp;      body.invoke(new Invokation(servicesFile.consumer));</b>
<b class="nc">&nbsp;      return null;</b>
&nbsp;    }
&nbsp;  };
&nbsp;
&nbsp;  private final static class ResourceKey {
<b class="nc">&nbsp;    private static final Joiner PACKAGE_RESOURCE_JOINER = Joiner.on(&#39;.&#39;).skipNulls();</b>
&nbsp;
&nbsp;    final String packageName;
&nbsp;    final String relativeName;
&nbsp;    // not included in equals/hashcode
&nbsp;    @Nullable Element originatingElement;
&nbsp;
&nbsp;    ResourceKey(String packageName, String simpleName) {
<b class="nc">&nbsp;      this(packageName, simpleName, null);</b>
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    ResourceKey(String packageName, String simpleName, @Nullable Element originatingElement) {</b>
<b class="nc">&nbsp;      this.packageName = checkNotNull(packageName);</b>
<b class="nc">&nbsp;      this.relativeName = checkNotNull(simpleName);</b>
<b class="nc">&nbsp;      this.originatingElement = originatingElement;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String toString() {
<b class="nc">&nbsp;      return PACKAGE_RESOURCE_JOINER.join(Strings.emptyToNull(packageName), relativeName);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int hashCode() {
<b class="nc">&nbsp;      return Objects.hash(packageName, relativeName);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean equals(Object obj) {
<b class="nc">&nbsp;      if (obj instanceof ResourceKey) {</b>
<b class="nc">&nbsp;        ResourceKey other = (ResourceKey) obj;</b>
<b class="nc">&nbsp;        return this.packageName.equals(other.packageName)</b>
<b class="nc">&nbsp;            || this.relativeName.equals(other.relativeName);</b>
&nbsp;      }
<b class="nc">&nbsp;      return false;</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private static class AppendServiceFile {
<b class="nc">&nbsp;    private static final Pattern SERVICE_FILE_COMMENT_LINE = Pattern.compile(&quot;^\\#.*&quot;);</b>
&nbsp;
&nbsp;    final ResourceKey key;
<b class="nc">&nbsp;    final Templates.CharConsumer consumer = new Templates.CharConsumer();</b>
&nbsp;
<b class="nc">&nbsp;    AppendServiceFile(ResourceKey key) {</b>
<b class="nc">&nbsp;      this.key = key;</b>
&nbsp;    }
&nbsp;
&nbsp;    void complete() {
&nbsp;      try {
<b class="nc">&nbsp;        writeFile();</b>
<b class="nc">&nbsp;      } catch (Exception ex) {</b>
<b class="nc">&nbsp;        EnvironmentState.processing().getMessager().printMessage(</b>
&nbsp;            Diagnostic.Kind.MANDATORY_WARNING,
&nbsp;            &quot;Cannot write service files: &quot; + key + ex);
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;
&nbsp;    private void writeFile() throws IOException {
<b class="nc">&nbsp;      LinkedHashSet&lt;String&gt; services = Sets.newLinkedHashSet();</b>
<b class="nc">&nbsp;      readExistingEntriesInto(services);</b>
<b class="nc">&nbsp;      copyNewMetaservicesInto(services);</b>
<b class="nc">&nbsp;      removeBlankLinesIn(services);</b>
<b class="nc">&nbsp;      writeLinesFrom(services);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void readExistingEntriesInto(Collection&lt;String&gt; services) {
&nbsp;      try {
<b class="nc">&nbsp;        FileObject existing = getFiler()</b>
<b class="nc">&nbsp;            .getResource(StandardLocation.CLASS_OUTPUT, key.packageName, key.relativeName);</b>
<b class="nc">&nbsp;        try (Reader r = existing.openReader(true)) {</b>
<b class="nc">&nbsp;          for (String line : CharStreams.readLines(r)) {</b>
<b class="nc">&nbsp;            if (!SERVICE_FILE_COMMENT_LINE.matcher(line).find()) {</b>
<b class="nc">&nbsp;              services.add(line.trim());</b>
&nbsp;            }
<b class="nc">&nbsp;          }</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;      } catch (Exception ex) {</b>
&nbsp;        // unable to read existing file
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;
&nbsp;    private void writeLinesFrom(Iterable&lt;String&gt; services) throws IOException {
<b class="nc">&nbsp;      FileObject resource = getFiler().createResource(StandardLocation.CLASS_OUTPUT, key.packageName, key.relativeName);</b>
<b class="nc">&nbsp;      try (Writer w = resource.openWriter()) {</b>
<b class="nc">&nbsp;        for (String line : services) {</b>
<b class="nc">&nbsp;          w.write(line);</b>
<b class="nc">&nbsp;          w.write(&#39;\n&#39;);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;
&nbsp;    private void removeBlankLinesIn(Iterable&lt;String&gt; services) {
<b class="nc">&nbsp;      Iterables.removeIf(services, Predicates.equalTo(&quot;&quot;));</b>
&nbsp;    }
&nbsp;
&nbsp;    private void copyNewMetaservicesInto(Collection&lt;String&gt; services) {
<b class="nc">&nbsp;      for (String line : Splitter.on(&quot;\n&quot;).split(consumer.asCharSequence())) {</b>
<b class="nc">&nbsp;        services.add(line);</b>
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private static class SourceFile {
&nbsp;    final ResourceKey key;
<b class="nc">&nbsp;    final Templates.CharConsumer consumer = new Templates.CharConsumer();</b>
<b class="nc">&nbsp;    boolean completed = false;</b>
&nbsp;
<b class="nc">&nbsp;    SourceFile(ResourceKey key) {</b>
<b class="nc">&nbsp;      this.key = key;</b>
&nbsp;    }
&nbsp;
&nbsp;    void complete() {
<b class="nc">&nbsp;      if (completed) return;</b>
<b class="nc">&nbsp;      completed = true;</b>
<b class="nc">&nbsp;      CharSequence sourceCode = extractSourceCode();</b>
&nbsp;      try {
<b class="nc">&nbsp;        JavaFileObject sourceFile = key.originatingElement != null</b>
<b class="nc">&nbsp;            ? getFiler().createSourceFile(key.toString(), Delegated.unwrap(key.originatingElement))</b>
<b class="nc">&nbsp;            : getFiler().createSourceFile(key.toString());</b>
&nbsp;
<b class="nc">&nbsp;        try (Writer writer = sourceFile.openWriter()) {</b>
<b class="nc">&nbsp;          writer.append(sourceCode);</b>
<b class="nc">&nbsp;          writer.flush();</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;      } catch (FilerException ex) {</b>
<b class="nc">&nbsp;        if (identicalFileIsAlreadyGenerated(sourceCode)) {</b>
<b class="nc">&nbsp;          getMessager().printMessage(Kind.NOTE, &quot;Regenerated file with the same content: &quot; + key);</b>
&nbsp;        } else {
<b class="nc">&nbsp;          getMessager().printMessage(Kind.MANDATORY_WARNING,</b>
<b class="nc">&nbsp;              String.format(</b>
&nbsp;                  &quot;Generated source file name collision. Attempt to overwrite already generated file: %s, %s.&quot;
&nbsp;                      + &quot; If this happens when using @Value.Immutable on same-named nested classes in the same package,&quot;
&nbsp;                      + &quot; use can use @Value.Enclosing annotation to provide some sort of namespacing&quot;,
&nbsp;                  key,
&nbsp;                  ex));
&nbsp;        }
<b class="nc">&nbsp;      } catch (IOException ex) {</b>
<b class="nc">&nbsp;        throw Throwables.propagate(ex);</b>
&nbsp;      } finally {
<b class="nc">&nbsp;        key.originatingElement = null; //attempt to not drag any round elements</b>
<b class="nc">&nbsp;      }</b>
&nbsp;    }
&nbsp;
&nbsp;    private boolean identicalFileIsAlreadyGenerated(CharSequence sourceCode) {
&nbsp;      try {
<b class="nc">&nbsp;        String packagePath = !key.packageName.isEmpty() ? (key.packageName.replace(&#39;.&#39;, &#39;/&#39;) + &#39;/&#39;) : &quot;&quot;;</b>
<b class="nc">&nbsp;        String filename = key.relativeName + &quot;.java&quot;;</b>
<b class="nc">&nbsp;        FileObject resource = getFiler().getResource(StandardLocation.SOURCE_OUTPUT, &quot;&quot;, packagePath + filename);</b>
&nbsp;
&nbsp;        String existingContent;
<b class="nc">&nbsp;        try (Reader r = resource.openReader(true)) {</b>
<b class="nc">&nbsp;          existingContent = CharStreams.toString(r);</b>
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        if (existingContent.contentEquals(sourceCode)) {</b>
&nbsp;          // We are ok, for some reason the same file is already generated,
&nbsp;          // happens in Eclipse for example.
<b class="nc">&nbsp;          return true;</b>
&nbsp;        }
<b class="nc">&nbsp;      } catch (Exception ignoredAttemptToGetExistingFile) {</b>
&nbsp;        // we have some other problem, not an existing file
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    private CharSequence extractSourceCode() {
<b class="nc">&nbsp;      CharSequence charSequence = consumer.asCharSequence();</b>
<b class="nc">&nbsp;      if (Strings.commonPrefix(charSequence, NO_IMPORTS).startsWith(NO_IMPORTS)) {</b>
<b class="nc">&nbsp;        return charSequence;</b>
&nbsp;      }
<b class="nc">&nbsp;      return PostprocessingMachine.rewrite(charSequence);</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private static Filer getFiler() {
<b class="nc">&nbsp;    return EnvironmentState.processing().getFiler();</b>
&nbsp;  }
&nbsp;
&nbsp;  private static Messager getMessager() {
<b class="nc">&nbsp;    return EnvironmentState.processing().getMessager();</b>
&nbsp;  }
&nbsp;
&nbsp;  private static Files getFiles() {
<b class="nc">&nbsp;    return EnvironmentState.getPerRound(Files.class, FilesSupplier.INSTANCE);</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  private enum FilesSupplier implements Supplier&lt;Files&gt; {</b>
<b class="nc">&nbsp;    INSTANCE;</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public Files get() {
<b class="nc">&nbsp;      return new Files();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  private static ServiceFiles getServiceFiles() {
<b class="nc">&nbsp;    return EnvironmentState.getPerProcessing(ServiceFiles.class, ServiceFilesSupplier.INSTANCE);</b>
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  private enum ServiceFilesSupplier implements Supplier&lt;ServiceFiles&gt; {</b>
<b class="nc">&nbsp;    INSTANCE;</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public ServiceFiles get() {
<b class="nc">&nbsp;      return new ServiceFiles();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
&nbsp;  // Do not use guava cache to slim down minimized jar
&nbsp;  @NotThreadSafe
<b class="nc">&nbsp;  private static abstract class Cache&lt;K, V&gt; {</b>
<b class="nc">&nbsp;    private final Map&lt;K, V&gt; map = new HashMap&lt;&gt;();</b>
&nbsp;
&nbsp;    protected abstract V load(K key) throws Exception;
&nbsp;
&nbsp;    final V get(K key) {
<b class="nc">&nbsp;      @Nullable V value = map.get(key);</b>
<b class="nc">&nbsp;      if (value == null) {</b>
&nbsp;        try {
<b class="nc">&nbsp;          value = load(key);</b>
<b class="nc">&nbsp;        } catch (Exception ex) {</b>
<b class="nc">&nbsp;          throw Throwables.propagate(ex);</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        map.put(key, value);</b>
&nbsp;      }
<b class="nc">&nbsp;      return value;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Map&lt;K, V&gt; asMap() {
<b class="nc">&nbsp;      return map;</b>
&nbsp;    }
&nbsp;
&nbsp;    void clear() {
<b class="nc">&nbsp;      map.clear();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  private static class Files implements Runnable {</b>
<b class="nc">&nbsp;    final Cache&lt;ResourceKey, SourceFile&gt; sourceFiles = new Cache&lt;ResourceKey, SourceFile&gt;() {</b>
&nbsp;      @Override
&nbsp;      public SourceFile load(ResourceKey key) throws Exception {
<b class="nc">&nbsp;        return new SourceFile(key);</b>
&nbsp;      }
&nbsp;    };
&nbsp;
&nbsp;    @Override
&nbsp;    public void run() {
&nbsp;      // file.complete() are called in-line, not here, to not force dragging
&nbsp;      // file content/char sequences till the end of a round
<b class="nc">&nbsp;      sourceFiles.clear();</b>
&nbsp;    }
&nbsp;  }
&nbsp;
<b class="nc">&nbsp;  private static class ServiceFiles implements Runnable {</b>
<b class="nc">&nbsp;    final Cache&lt;ResourceKey, AppendServiceFile&gt; appendResourceFiles = new Cache&lt;ResourceKey, AppendServiceFile&gt;() {</b>
&nbsp;      @Override
&nbsp;      public AppendServiceFile load(ResourceKey key) throws Exception {
<b class="nc">&nbsp;        return new AppendServiceFile(key);</b>
&nbsp;      }
&nbsp;    };
&nbsp;
&nbsp;    @Override
&nbsp;    public void run() {
<b class="nc">&nbsp;      for (AppendServiceFile f : appendResourceFiles.asMap().values()) {</b>
<b class="nc">&nbsp;        f.complete();</b>
<b class="nc">&nbsp;      }</b>
<b class="nc">&nbsp;      appendResourceFiles.clear();</b>
&nbsp;    }
&nbsp;  }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-11-04 15:34</div>
</div>
</body>
</html>
